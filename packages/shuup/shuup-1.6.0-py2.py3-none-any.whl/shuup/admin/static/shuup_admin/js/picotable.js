"use strict";var Picotable=function(e,t){function n(t){for(var n=0,i=1;i<t.length;i++)if(t[i]._page!==t[i-1]._page+1){var r=e("li",{key:"dummy"+n++,className:"disabled"},e("a",{href:"#"},"â‹¯"));t.splice(i,0,r),i++}}function i(t,i){if(0===t.nItems)return e("nav");for(var r=e.withAttr("rel",i),a=t.pageNum,l=[],o=function(t,n){return e("a",{rel:t,href:"#",onclick:r},n||t)},c=1;c<=t.nPages;c++)if(1===c||c===t.nPages||Math.abs(c-a)<=2){var s=e("li",{key:c,className:S({active:a===c})},o(c));s._page=c,l.push(s)}n(l);var u=e("li",{key:"previous",className:S({disabled:1===a})},o(a-1,gettext("Previous"))),d=e("li",{key:"next",className:S({disabled:a===t.nPages})},o(a+1,gettext("Next")));return e("nav",e("ul.pagination",u,l,d))}function r(e){return function(t,n,i){n||(t.oninput=i.debouncedOnInput=x.debounce(t.onchange,e))}}function a(t,n,i){var r=function(){var e=JSON.parse(this.value);t.setFilterValue(n.id,e)},a=function(){return function(e,t){t||$(e).select2()}},l=e("select.form-control",{config:n.filter.select2?a():null,value:JSON.stringify(i),onchange:r},x.map(n.filter.choices,function(t){return e("option",{value:JSON.stringify(t[0]),key:t[0]},t[1])}));return e("div.choice-filter",l)}function l(e){for(var t=e.vm.data(),n={},i=0;i<t.columns.length;i++)if(t.columns[i].filter){var r=t.columns[i].filter.defaultChoice;r&&(n[t.columns[i].id]=r)}return n}function o(t,n,i){var a=function(e){var i=x.extend({},t.getFilterValue(n.id)||{}),r=this.value;x.trim(r)||(r=null),i[e]=r,t.setFilterValue(n.id,i)},l={type:n.filter.range.type||"text"},o=!1;"date"===l.type&&(o=!0,l.type="text"),x.map(["min","max","step"],function(e){var t=n.filter.range[e];void 0!==t&&null!==t&&(l[e]=t,l.type="number")}),i=i||{};var c=e("input.form-control",x.extend({},l,{value:x.stringValue(i.min),placeholder:k.RANGE_FROM,onchange:function(){a.call(this,"min")},config:o?t.datePicker():r(500)})),s=e("input.form-control",x.extend({},l,{value:x.stringValue(i.max),placeholder:k.RANGE_TO,onchange:function(){a.call(this,"max")},config:o?t.datePicker():r(500)}));return e("div.range-filter",[e("div.input-wrapper.min",{key:"min"},c),e("div.input-wrapper.max",{key:"max"},s)])}function c(t,n,i){var a=function(){t.setFilterValue(n.id,this.value)},l=e("input.form-control",{type:n.filter.text.type||"text",value:x.stringValue(i),placeholder:n.filter.placeholder||interpolate(gettext("Filter by %s"),[n.title]),onchange:a,config:r(500)});return e("div.text-filter",l)}function s(e,t){var n=e.getFilterValue(t.id);return t.filter.choices?a(e,t,n):t.filter.range?o(e,t,n):t.filter.text?c(e,t,n):void 0}function u(t,n,i){var r=null,a={"":n.className},l=null;if(n.sortable){var o=t.vm.sort(),c=null;o==="+"+n.id&&(c="asc"),o==="-"+n.id&&(c="desc");var s="fa-sort"+(c?"-"+c:"");r=e("i.fa."+s),a.sortable=!0,c&&(a["sorted-"+c]=!0),l=function(){t.setSortColumn(n.id)}}var u={key:n.id,className:S(a),onclick:l},d=t.vm.data()?t.vm.data().massActions:null;return d.length&&(0===i&&(u.className+=" hidden"),1===i&&(u.colspan=2)),e("th",u,[r," ",n.title])}function d(t,n,i){var r=null;n.filter&&(r=s(t,n));var a={key:n.id,className:n.className||""},l=t.vm.data()?t.vm.data().massActions:null;return l.length&&(0===i&&(a.className+=" hidden"),1===i&&(a.colspan=2)),e("th",a,[r])}function f(t){var n=t.vm.data();if(null!==n){var r=x.extend(l(t),t.vm.filterValues());t.vm.filterValues(r);var a=x.map(n.columns,function(e,n){return u(t,e,n)}),o=x.any(n.columns,x.property("filter"))?x.map(n.columns,function(e,n){return d(t,e,n)}):null,c=e("thead",[e("tr.headers",a),o?e("tr.filters",o):null]),s=n.columns.length,f=e("td",{colspan:s},i(n.pagination,t.setPage)),m=e("tfoot",[e("tr",f)]),p=t.vm.data()?t.vm.data().massActions:null,g=!!t.vm.pickId(),h=x.map(n.items,function(i){var r={key:"item-"+i._id};return p.length&&(r.onclick=function(){t.saveCheck(i)},r["class"]=t.isChecked(i)?"active":""),e("tr",r,x.map(n.columns,function(n,r){var a;return a=0===r&&p.length?e("input[type=checkbox]",{value:i.type+"-"+i._id,"class":"row-selection",onclick:x.boundPartial(t,t.saveCheck,i),checked:t.isChecked(i)}):i[n.id]||"",n.raw&&(a=e.trust(a)),n.linked&&(g?a=e("a",{href:"#",onclick:x.boundPartial(t,t.pickObject,i)},a):i._url&&(a=e("a",{href:i._url,onclick:v},a))),e("td",{key:"col-"+n.id,className:n.className||""},[a])}))}),b=e("tbody",h),w=p.length?".has-mass-actions":"";return e("table.table.table-striped.picotable-table"+w,[c,m,b])}}function v(e){e.stopPropagation()}function m(t){var n=t.vm.data(),i=x.map(n.columns,function(n){return n.filter?e("div.single-filter",e("h3",n.title),s(t,n)):null});return e("div.mobile-filters.shuup-modal-bg",{key:"mobileFilterModal"},[e("div.shuup-modal-container",[e("div.shuup-modal-header",[e("h2.pull-left",[e("i.fa.fa-filter")],gettext("Filters")),e("button.btn.btn-success.pull-right",{onclick:function(){t.vm.showMobileFilterSettings(!1)}},"Done"),e("button.btn.btn-gray.btn-inverse.pull-right",{onclick:t.resetFilters,disabled:x.isEmpty(t.vm.filterValues())},k.RESET)]),e("div.mobile-filters-content",i)])])}function p(t){var n=t.vm.data(),i=[];if(x.map(n.columns,function(e){e.sortable&&(i.push({value:"+"+e.id,text:""+k.SORT_BY+" "+e.title+" "+k.SORT_ASC}),i.push({value:"-"+e.id,text:""+k.SORT_BY+" "+e.title+" "+k.SORT_DESC}))}),i.length)return i.unshift({value:"",text:k.SORT_DEFAULT}),e("select.picotable-mobile-sort.form-control",{id:"mobile-sort-select",value:t.vm.sort()||"",onchange:e.withAttr("value",function(e){t.setSortColumn(e),t.refresh()})},x.map(i,function(t){return e("option",{value:t.value},t.text)}))}function g(t){var n=t.vm.data();if(null!==n){var r=x.extend(l(t),t.vm.filterValues());t.vm.filterValues(r);var a=!!t.vm.pickId(),o=x.map(n.items,function(i){var r=null;i._abstract&&i._abstract.length&&(r=x.map(i._abstract,function(t){if(t&&("string"==typeof t&&(t={text:t}),t.text)){t.raw&&(t.text=e.trust(t.raw));var n="div.inner-row."+(t.title?"with-title":"")+(t["class"]?"."+t["class"]:"");return e(n,[t.title?e("div.column.title",t.title):null,e("div.column",t.text)])}}),x.any(r,function(e){return!!e})||(r=null)),null===r&&(r=x.map(n.columns,function(t){var n=i[t.id]||"";return t.raw&&(n=e.trust(n)),e("div.inner-row.with-title",[e("div.column.title",t.title),e("div.column",n)])}));var l={href:i._url};a&&(l.onclick=x.boundPartial(t,t.pickObject,i),l.href="#");var o=i._linked_in_mobile?e("a.inner",l,r):e("span.inner",r);return e("div.list-element",o)});return e("div.mobile",[e("div.row.mobile-header",[e("div.col-sm-6",[e("button.btn.btn-info.btn-block.toggle-btn",{onclick:function(){t.vm.showMobileFilterSettings(!0)}},[e("i.fa.fa-filter")],"Show filters")]),e("div.col-sm-6",[e("div.mobile-sort",p(t))])]),t.vm.showMobileFilterSettings()?m(t):null,e("hr"),e("div.mobile-items",o),i(n.pagination,t.setPage)])}}function h(t){var n=t.vm.data()?t.vm.data().massActions:null,i=!!t.vm.pickId();if(null===n||i)return"";var r=function(){return function(e,t){t||$(e).select2()}},a=t.vm.data().pagination.nItems;if(0===a)return"";var l=t.vm.data().items.length,o=[{key:0,value:gettext("Select Action")},{key:"unselect_all",value:gettext("Clear Selections")},{key:"select_all",value:gettext("Select All")},{key:"select_listed",value:interpolate(gettext("Select All %s Items"),[l])}];return n=o.concat(n),e("div.picotable-mass-actions",[t.vm.allItemsSelected()?e("p",interpolate(gettext("All %s Items Selected"),[a])):null,e("select.picotable-mass-action-select.form-control",{id:"mass-action-select"+t.id,config:r(),value:0,onchange:e.withAttr("value",function(e){t.doMassAction(e)})},x.map(n,function(t){var n=["key","value"],i={value:t.key};return Object.keys(t).forEach(function(e){if(!n.includes(n)){var r=e.replace("_","-");i["data-"+r]=t[e]}}),e("option",i,t.value)}))])}function b(t){var n=t.vm.data()?t.vm.data().itemInfo:null;return e("div.picotable-header",[h(t),e("div.picotable-items-per-page-ctr",[e("select.picotable-items-per-page-select.form-control",{id:"pipps"+t.id,value:t.vm.perPage(),onchange:e.withAttr("value",function(e){t.vm.perPage(e),t.refresh()})},x.map(t.vm.perPageChoices(),function(t){return e("option",{value:t},t+" / "+k.PAGE)}))]),e("div.picotable-item-info",n),e("div.picotable-reset-filters-ctr",e("button.picotable-reset-filters-btn.btn.btn-gray.btn-inverse",{onclick:t.resetFilters,disabled:x.isEmpty(t.vm.filterValues())},k.RESET_FILTERS))])}function w(t){return e("div.table-view",[t.vm.showHeader()?b(t):null,"mobile"===t.vm.renderMode()?g(t):f(t)])}function y(){var n=this;n.id="0"|134217727*Math.random(),n.vm={url:e.prop(null),sort:e.prop(null),filterEnabled:e.prop({}),filterValues:e.prop({}),checkboxes:e.prop([]),allItemsSelected:e.prop(!1),page:e.prop(1),perPage:e.prop(20),perPageChoices:e.prop([20,50,100,200]),showHeader:e.prop(!0),data:e.prop(null),renderMode:e.prop("normal"),showMobileFilterSettings:e.prop(!1),pickId:e.prop(null)},n.setRenderMode=function(e){var t=n.vm.renderMode();n.vm.renderMode(e),e!==t&&n.refresh()},n.adaptRenderMode=function(){var e=window.innerWidth;n.setRenderMode(e<992?"mobile":"normal")},n.setSource=function(e){n.vm.url(e),n.refresh()},n.setSortColumn=function(e){var t=null;if(e&&e.length&&"null"!==e)if(/^[+-]/.test(e))t=e;else{var i=n.vm.sort();t=i==="+"+e?"-"+e:i==="-"+e?null:"+"+e}n.vm.sort(t),n.refresh()},n.getFilterValue=function(e){return n.vm.filterValues()[e]},n.setFilterValue=function(e,t){var i=n.vm.filterValues();"string"==typeof t&&""===x.trim(t)&&(t=null),i[e]=t,i=x.omitNulls(i),n.vm.filterValues(i),n.refresh()},n.resetFilters=function(){n.vm.filterValues({}),n.refresh()},n.resetCheckboxes=function(){n.vm.allItemsSelected(!1),n.vm.checkboxes([])},n.saveCheck=function(e){var t=n.vm.checkboxes(),i=t.filter(function(t){return t!==e._id});i.length<t.length?n.vm.checkboxes(i):(t.push(e._id),n.vm.checkboxes(t)),$(e).toggleClass("active")},n.isChecked=function(e){var t=n.vm.checkboxes(),i=t.filter(function(t){return t===e._id});return i.length>0},n.getMassActionResponse=function(e){if(200===e.status){var t="",i=e.getResponseHeader("Content-Disposition");if(i&&i.indexOf("attachment")!==-1){var r=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/,a=r.exec(i);null!==a&&a[1]&&(t=a[1].replace(/['"]/g,""))}var l=e.getResponseHeader("Content-Type"),o=new Blob([e.response],{type:l});if("undefined"!=typeof window.navigator.msSaveBlob)window.navigator.msSaveBlob(o,t);else{var c=window.URL||window.webkitURL,s=c.createObjectURL(o);if(t){var u=document.createElement("a");"undefined"==typeof u.download?window.location=s:(u.href=s,u.download=t,document.body.appendChild(u),u.click())}else{var d=$("option[value="+window.savedValue+"]").data("redirects");d&&(window.location=$("option[value="+window.savedValue+"]").data("redirect-url")),n.resetCheckboxes(),$(".picotable-mass-action-select").val(0),n.refresh(),setTimeout(function(){window.Messages.enqueue({tags:"success",text:gettext("Mass Action complete.")})},1e3)}setTimeout(function(){c.revokeObjectURL(s)},100)}}else n.resetCheckboxes(),$(".picotable-mass-action-select").val(0),n.refresh(),setTimeout(function(){window.Messages.enqueue({tags:"error",text:gettext("Something went wrong.")})},1e3)},n.doMassAction=function(t){switch(t){case"select_all":return void n.selectAllProducts();case"select_listed":return void n.selectAllListedProducts();case"unselect_all":return void n.resetCheckboxes()}var i=n.vm.checkboxes();if(window.savedValue=t,0===i.length)return void alert(gettext("You haven't selected anything"));if(0!==t){if(!confirm(gettext("Confirm action by clicking OK!")))return $(".picotable-mass-action-select").val(0),void n.refresh();var r=function(e){e.setRequestHeader("X-CSRFToken",window.ShuupAdminConfig.csrf),e.setRequestHeader("Content-type","application/json"),e.responseType="blob"},a={action:t,values:n.vm.allItemsSelected()?"all":i},l=$("option[value="+t+"]").data("callback");l&&window[l]?window[l](a.values):e.request({method:"POST",url:window.location.pathname,data:a,extract:n.getMassActionResponse,config:r})}},n.selectAllListedProducts=function(){n.vm.allItemsSelected(!1),n.vm.checkboxes(n.vm.data().items.map(function(e){return e._id}))},n.selectAllProducts=function(){n.selectAllListedProducts(),n.vm.allItemsSelected(!0)},n.setPage=function(e){e=0|e,(isNaN(e)||e<1)&&(e=1),n.vm.page(e),n.refresh()},n.refresh=function(){var t=n.vm.url();if(t){var i={sort:n.vm.sort(),perPage:0|n.vm.perPage(),page:0|n.vm.page(),filters:n.vm.filterValues()},r=e.route.parseQueryString(decodeURI(location.search));r.jq=JSON.stringify(i),e.request({method:"GET",url:t,data:r}).then(n.vm.data,function(){alert("An error occurred.")}),n.saveSettings()}},n.saveSettings=function(){t&&t.setItem("picotablePerPage",n.vm.perPage())},n.loadSettings=function(){if(t){var e=0|t.getItem("picotablePerPage");e>1&&n.vm.perPage(e);var i=/pick=([^&]+)/.exec(location.search);n.vm.pickId(i?i[1]:null)}},n.pickObject=function(e){var t=window.opener;if(!t)return void alert("Window has no opener. Can't pick object.");var i=null;x.map(["_text","_name","title","name","text"],function(t){!i&&e[t]&&(i=e[t])}),!i&&e._abstract&&e._abstract.length>0&&(i=e._abstract[0],i.text&&(i=i.text)),i||(i="#"+e._id),t.postMessage({pick:{id:n.vm.pickId(),object:{id:e._id,text:i,url:e._url}}},"*"),event.preventDefault()},n.datePicker=function(){return function(e,t){t||$(e).datetimepicker({format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,todayHighlight:!0,fontAwesome:!0,minView:2})}},n.loadSettings(),n.adaptRenderMode(),window.addEventListener("resize",x.debounce(n.adaptRenderMode,100)),e.deferred.onerror=function(e){if(!e.toString().match(/^SyntaxError/)&&"[object Error]"==={}.toString.call(e)&&!e.constructor.toString().match(/ Error/))throw e}}e=e||require("mithril");var x=function(){function t(e){return function(t){return t[e]}}function n(e,t){return Array.isArray(e)?e.map(t):Object.keys(e).map(function(n){return t(e[n],n,e)})}function i(e,t){return Array.isArray(e)?e.some(t):Object.keys(e).some(function(n){return t(e[n],n,e)})}function r(){for(var e=arguments[0],t=1;t<arguments.length;t++)for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e}function a(e){return(""+e).replace(/^\s+|\s+$/g,"")}function l(e){var t={};return n(e,function(e,n){null!==e&&(t[n]=e)}),t}function o(t,n){function i(){return l=this,o=arguments,c=(new Date).getTime(),s||(e.startComputation(),s=setTimeout(r,n),a&&(u=t.apply(l,o),l=o=null)),u}function r(){var i=(new Date).getTime()-c;i<n&&i>0?s=setTimeout(r,n-i):(s=null,a||(u=t.apply(l,o),l=o=null),e.endComputation())}var a=!(arguments.length<=2||void 0===arguments[2])&&arguments[2],l=void 0,o=void 0,c=void 0,s=void 0,u=void 0;return i}function c(e){return null===e||void 0===e?"":Array.isArray(e)&&0===e.length?"":""+e}function s(e){if(e.length)return!1;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function u(e,t){var n=[].slice.call(arguments,2);return function(){var i=n.concat([].slice.call(arguments));return t.apply(e,i)}}return{property:t,map:n,any:i,extend:r,trim:a,omitNulls:l,debounce:o,stringValue:c,isEmpty:s,boundPartial:u}}(),k={MASS_ACTIONS:gettext("Mass actions"),RANGE_FROM:gettext("From"),RANGE_TO:gettext("To"),ITEMS_PER_PAGE:gettext("Items per page"),PAGE:gettext("Page"),RESET_FILTERS:gettext("Reset filters"),RESET:gettext("Reset"),SORT_BY:gettext("Sort by"),SORT_ASC:gettext("ascending"),SORT_DESC:gettext("descending"),SORT_DEFAULT:gettext("Default sorting")},S=function(e){var t=[];return x.map(e||{},function(e,n){var i=null;i=""===n?e&&e.length?""+e:null:e?n:null,i&&t.push(i)}),t.join(" ")},_=function(t,n){this.ctrl=e.mount(t,{view:w,controller:y}),this.ctrl.setSource(n)};return _.lang=k,_}(window.m,window.localStorage);"undefined"!=typeof module&&null!==module&&module.exports?module.exports=Picotable:"function"==typeof define&&define.amd&&define(function(){return Picotable});
//# sourceMappingURL=picotable.js.map
